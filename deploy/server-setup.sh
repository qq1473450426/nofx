#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œæ­¤è„šæœ¬ï¼ˆå·²ç™»å½•æœåŠ¡å™¨åï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    ğŸ³ æœåŠ¡å™¨ç«¯ Docker éƒ¨ç½²æ­¥éª¤                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¯·æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬1æ­¥ï¼šæ£€æŸ¥Dockerç¯å¢ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

# æ£€æŸ¥Docker
echo "æ‰§è¡Œï¼šæ£€æŸ¥Docker..."
if command -v docker &> /dev/null; then
    echo "âœ“ Dockerå·²å®‰è£…: $(docker --version)"
else
    echo "âŒ Dockeræœªå®‰è£…"
    echo ""
    echo "å®‰è£…Dockerå‘½ä»¤ï¼š"
    echo "  curl -fsSL https://get.docker.com | sh"
    echo "  systemctl enable docker"
    echo "  systemctl start docker"
    echo ""
    exit 1
fi

# æ£€æŸ¥Docker Compose
if command -v docker-compose &> /dev/null; then
    echo "âœ“ Docker Composeå·²å®‰è£…: $(docker-compose --version)"
else
    echo "âŒ Docker Composeæœªå®‰è£…"
    echo ""
    echo "å®‰è£…Docker Composeå‘½ä»¤ï¼š"
    echo "  curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose"
    echo "  chmod +x /usr/local/bin/docker-compose"
    echo ""
    exit 1
fi

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬2æ­¥ï¼šæ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

echo "æ‰§è¡Œï¼šæŸ¥æ‰¾ä¸Šä¼ çš„tar.gzæ–‡ä»¶..."
PACKAGE=$(ls -t /tmp/nofx_*.tar.gz 2>/dev/null | head -1)
if [ -z "$PACKAGE" ]; then
    echo "âŒ æ‰¾ä¸åˆ°ä¸Šä¼ çš„æ–‡ä»¶"
    echo ""
    echo "è¯·å…ˆä»æœ¬åœ°ä¸Šä¼ ï¼š"
    echo "  cd /Users/sunjiaqiang/nofx"
    echo "  ./deploy/package.sh"
    echo "  scp nofx_*.tar.gz root@æœåŠ¡å™¨IP:/tmp/"
    echo ""
    exit 1
else
    echo "âœ“ æ‰¾åˆ°æ–‡ä»¶: $PACKAGE"
    echo "  å¤§å°: $(du -h "$PACKAGE" | cut -f1)"
fi

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬3æ­¥ï¼šåˆ›å»ºéƒ¨ç½²ç›®å½•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

echo "æ‰§è¡Œï¼šåˆ›å»º/opt/nofxç›®å½•..."
mkdir -p /opt/nofx
cd /opt/nofx
echo "âœ“ å·¥ä½œç›®å½•: $(pwd)"

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬4æ­¥ï¼šè§£å‹é¡¹ç›®æ–‡ä»¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

echo "æ‰§è¡Œï¼šè§£å‹..."
tar -xzf "$PACKAGE" --strip-components=1
echo "âœ“ è§£å‹å®Œæˆ"
echo ""
echo "æ–‡ä»¶åˆ—è¡¨ï¼š"
ls -lh | head -15

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬5æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

if [ ! -f .env ]; then
    cat > .env << 'ENVEOF'
NOFX_BACKEND_PORT=8080
NOFX_FRONTEND_PORT=3000
NOFX_TIMEZONE=Asia/Shanghai
ENVEOF
    echo "âœ“ å·²åˆ›å»º .env æ–‡ä»¶"
else
    echo "âœ“ .env å·²å­˜åœ¨"
fi

cat .env

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬6æ­¥ï¼šé…ç½®APIå¯†é’¥ âš ï¸ é‡è¦ï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

if [ ! -f config.json ]; then
    if [ -f config.json.example ]; then
        cp config.json.example config.json
        echo "âœ“ å·²åˆ›å»º config.json"
    fi
fi

echo ""
echo "âš ï¸  è¯·ç¼–è¾‘ config.json å¡«å…¥ä½ çš„APIå¯†é’¥ï¼š"
echo ""
echo "  nano /opt/nofx/config.json"
echo ""
echo "éœ€è¦å¡«å†™ï¼š"
echo "  - binance_api_key: ä½ çš„å¸å®‰APIå¯†é’¥"
echo "  - binance_secret_key: ä½ çš„å¸å®‰Secretå¯†é’¥"
echo "  - qwen_key: ä½ çš„é€šä¹‰åƒé—®APIå¯†é’¥"
echo ""
read -p "å·²ç»é…ç½®å¥½APIå¯†é’¥äº†å—ï¼Ÿç»§ç»­ï¼Ÿ[y/N]: " configured

if [ "$configured" != "y" ] && [ "$configured" != "Y" ]; then
    echo ""
    echo "è¯·å…ˆé…ç½®APIå¯†é’¥ï¼Œç„¶åè¿è¡Œï¼š"
    echo "  cd /opt/nofx"
    echo "  docker-compose up -d"
    exit 0
fi

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬7æ­¥ï¼šå¯åŠ¨DockeræœåŠ¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

echo "æ‰§è¡Œï¼šå¯åŠ¨Docker Compose..."
docker-compose up -d

echo ""
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

cat << 'EOF'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬8æ­¥ï¼šéªŒè¯éƒ¨ç½²
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

echo "æ‰§è¡Œï¼šæ£€æŸ¥å®¹å™¨çŠ¶æ€..."
docker-compose ps

echo ""
echo "æ‰§è¡Œï¼šæ£€æŸ¥APIå¥åº·..."
sleep 2
curl -s http://localhost:8080/health || echo "APIæš‚æœªå“åº”ï¼ˆå¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­ï¼‰"

cat << 'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    âœ… éƒ¨ç½²å®Œæˆï¼                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ æœåŠ¡ä¿¡æ¯ï¼š
  éƒ¨ç½²ç›®å½•: /opt/nofx
  APIç«¯å£: 8080
  Webç«¯å£: 3000

ğŸ“Š ç®¡ç†å‘½ä»¤ï¼š
  æŸ¥çœ‹çŠ¶æ€: docker-compose ps
  æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f nofx
  é‡å¯æœåŠ¡: docker-compose restart
  åœæ­¢æœåŠ¡: docker-compose down
  æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€: ./status.sh

ğŸ” éªŒè¯éƒ¨ç½²ï¼š
  æµ‹è¯•API: curl http://localhost:8080/health
  æŸ¥çœ‹æ—¥å¿—: docker-compose logs nofx | tail -50
  æŸ¥çœ‹å†³ç­–: ls -lt decision_logs/binance_live_qwen/*.json | head -1

ğŸ“ ä¸‹ä¸€æ­¥ï¼š
  1. å¦‚æœä¿®æ”¹äº†config.jsonï¼Œé‡å¯æœåŠ¡ï¼š
     docker-compose restart

  2. æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š
     docker-compose logs -f nofx

  3. ç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼š
     watch -n 5 './status.sh'

ğŸ†˜ é‡åˆ°é—®é¢˜ï¼Ÿ
  æ£€æŸ¥å®¹å™¨æ—¥å¿—: docker-compose logs nofx
  æ£€æŸ¥é…ç½®: cat config.json | jq .
  é‡æ–°æ„å»º: docker-compose down && docker-compose up -d --build

EOF
