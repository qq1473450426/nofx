# ğŸ”§ æ—¶é—´å‘¨æœŸç»Ÿä¸€ä¿®å¤

## é—®é¢˜å‘ç°

### ç”¨æˆ·åé¦ˆ
> "æˆ‘æ˜¯è¦çŸ¥é“æˆ‘ä»¬æä¾›æ•°æ®ç»™ä»–åä»–çš„åˆ†æå¯¹ä¸å¯¹"

é€šè¿‡éªŒè¯AIåˆ†æå‡†ç¡®æ€§ï¼Œå‘ç°ï¼š

**AIè¯´**ï¼š
> "æŠ€æœ¯é¢æ˜¾ç¤ºä»·æ ¼å¤„äºå¼ºåŠ²ä¸‹è¡Œè¶‹åŠ¿ï¼Œä½äºæ‰€æœ‰EMAå‡çº¿ä¸‹æ–¹"

**å®é™…æ•°æ®éªŒè¯**ï¼š
```
å½“å‰ä»·æ ¼: 102255
EMA20: 102211  â† ä»·æ ¼åœ¨ä¸Šæ–¹ï¼
EMA50: 101985  â† ä»·æ ¼åœ¨ä¸Šæ–¹ï¼
EMA200: 101878 â† ä»·æ ¼åœ¨ä¸Šæ–¹ï¼
```

â†’ **AIè¯´ä¸‹è¡Œï¼Œæ•°æ®æ˜¾ç¤ºä¸Šæ–¹ï¼Œå®Œå…¨ç›¸åï¼**

---

## æ ¹æœ¬åŸå› 

### âŒ æ—¶é—´å‘¨æœŸä¸åŒ¹é…

**æ—§ä»£ç ** (market/data.go):
```go
// è·å–3åˆ†é’ŸKçº¿æ•°æ®
klines3m, err := getKlines(symbol, "3m", 40)
currentPrice := klines3m[len(klines3m)-1].Close  // â† 3åˆ†é’Ÿä»·æ ¼

// è·å–4å°æ—¶Kçº¿æ•°æ®
klines4h, err := getKlines(symbol, "4h", 220)
longerTermData := calculateLongerTermData(klines4h)  // â† 4å°æ—¶EMA

// å¯¹æ¯”
aboveEMA20 := currentPrice > longerTermData.EMA20  // â† 3åˆ†é’Ÿä»·æ ¼ vs 4å°æ—¶EMAï¼
```

### ä¸ºä»€ä¹ˆå¯¼è‡´é”™è¯¯ï¼Ÿ

| æ—¶é—´ç»´åº¦ | æ•°æ® | è¶‹åŠ¿ |
|---------|------|------|
| **4å°æ—¶çº§åˆ«** | ä»105000è·Œåˆ°102000 | ä¸‹è·Œè¶‹åŠ¿ â†’ EMAå‘ä¸‹ |
| **3åˆ†é’Ÿçº§åˆ«** | ä»101800åå¼¹åˆ°102300 | çŸ­æœŸåå¼¹ |

**å¯¹æ¯”ç»“æœ**ï¼š
```
3åˆ†é’Ÿä»·æ ¼(102300) > 4å°æ—¶EMA(102000)
â†’ æ˜¾ç¤ºâœ“ "Strong uptrend"
```

ä½†è¿™æ˜¯**è¯¯å¯¼æ€§çš„**ï¼š
- ä¸æ˜¯"Strong uptrend"
- åªæ˜¯çŸ­æœŸä»·æ ¼ > é•¿æœŸEMA
- **ä¸åŒæ—¶é—´ç»´åº¦çš„æ•°æ®ä¸èƒ½ç›´æ¥å¯¹æ¯”ï¼**

### Promptç»™AIçš„ä¿¡æ¯

```
Position vs EMAs: âœ“ EMA20(102000) | âœ“ EMA50(101800) | âœ“ EMA200(101500)
â†’ Trend: Strong uptrend (above all EMAs)
```

**AIçœ‹åˆ°è¿™ä¸ªä¼šå¦‚ä½•ç†è§£ï¼Ÿ**

**æƒ…å†µA - AIåªçœ‹æ ‡ç­¾**ï¼š
- çœ‹åˆ°"Strong uptrend"
- åº”è¯¥é¢„æµ‹up
- ä½†AIè¯´down â†’ AIæœ‰é—®é¢˜ï¼ŸâŒ

**æƒ…å†µB - AIç†è§£äº†æ—¶é—´ç»´åº¦é—®é¢˜**ï¼š
- æ„è¯†åˆ°æ˜¯3åˆ†é’Ÿä»·æ ¼ vs 4å°æ—¶EMA
- ä»é•¿æœŸçœ‹ä»åœ¨ä¸‹è·Œè¶‹åŠ¿ï¼ˆ4å°æ—¶ç»´åº¦ï¼‰
- æ‰€ä»¥é¢„æµ‹down â†’ AIæ˜¯å¯¹çš„ï¼âœ…

**ç»“è®º**ï¼šä¸æ˜¯AIé”™è¯¯ï¼Œæ˜¯**æˆ‘ä»¬çš„æ•°æ®æ··æ·†äº†æ—¶é—´ç»´åº¦**ï¼

---

## ä¿®å¤æ–¹æ¡ˆ

### âœ… ç»Ÿä¸€ä½¿ç”¨5åˆ†é’ŸKçº¿

**ç”¨æˆ·è¯´æ˜**ï¼šå½“å‰å†³ç­–å‘¨æœŸæ˜¯5åˆ†é’Ÿ

**ä¿®å¤å** (market/data.go:163-193):

```go
// ğŸ”§ ä¿®å¤æ—¶é—´å‘¨æœŸä¸åŒ¹é…é—®é¢˜ï¼šç»Ÿä¸€ä½¿ç”¨5åˆ†é’ŸKçº¿
klines5m, err := getKlines(symbol, "5m", 300) // 300æ ¹ = 25å°æ—¶å†å²

// æ‰€æœ‰æŒ‡æ ‡å…¨éƒ¨åŸºäº5åˆ†é’ŸKçº¿ï¼ˆæ—¶é—´ç»´åº¦ç»Ÿä¸€ï¼‰
currentPrice := klines5m[len(klines5m)-1].Close      // 5åˆ†é’Ÿä»·æ ¼
currentEMA20 := calculateEMA(klines5m, 20)            // 5åˆ†é’ŸEMA20
currentRSI7 := calculateRSI(klines5m, 7)              // 5åˆ†é’ŸRSI
currentMACD := calculateMACD(klines5m)                // 5åˆ†é’ŸMACD

// ä»·æ ¼å˜åŒ–ä¹ŸåŸºäº5åˆ†é’ŸKçº¿
priceChange1h = (price_now - price_12_bars_ago) / price_12_bars_ago * 100  // 12*5m=1h
priceChange4h = (price_now - price_48_bars_ago) / price_48_bars_ago * 100  // 48*5m=4h

// é•¿æœŸæ•°æ®ä¹Ÿç”¨5åˆ†é’ŸKçº¿
intradayData := calculateIntradaySeries(klines5m)
longerTermData := calculateLongerTermData(klines5m)  // EMA20/50/200éƒ½åŸºäº5åˆ†é’Ÿ
```

### âœ… æ›´æ–°Promptæ ‡æ³¨

**ä¿®å¤å** (prediction_agent.go:208, 270, 286):

```go
// 1. æ˜ç¡®è¯´æ˜æ‰€æœ‰æŒ‡æ ‡éƒ½æ˜¯5åˆ†é’ŸKçº¿
userPrompt = "Context: Binance futures, primary interval=5m (all indicators use 5-minute candles).\n"

// 2. EMAæ˜¾ç¤ºæ˜ç¡®æ ‡æ³¨æ—¶é—´å‘¨æœŸ
userPrompt += fmt.Sprintf("Position vs EMAs (5m): %s EMA20(%.2f) | %s EMA50(%.2f) | %s EMA200(%.2f)\n",
    ema20Status, ltc.EMA20, ema50Status, ltc.EMA50, ema200Status, ltc.EMA200)

// 3. è¶‹åŠ¿è§£è¯»æ›´å‡†ç¡®ï¼Œä¸ç”¨è¯¯å¯¼æ€§çš„"Strong uptrend"
if aboveEMA20 && aboveEMA50 && aboveEMA200 {
    trendInterpretation = "Price above all EMAs (bullish structure on 5m)"
} else if !aboveEMA20 && !aboveEMA50 && !aboveEMA200 {
    trendInterpretation = "Price below all EMAs (bearish structure on 5m)"
}
userPrompt += fmt.Sprintf("  â†’ Trend (5m): %s\n", trendInterpretation)
```

**å…³é”®æ”¹è¿›**ï¼š
1. âŒ æ—§ï¼š`"Strong uptrend"` â†’ è¯¯å¯¼ï¼Œæš—ç¤ºé•¿æœŸå¼ºè¶‹åŠ¿
2. âœ… æ–°ï¼š`"Price above all EMAs (bullish structure on 5m)"` â†’ å‡†ç¡®ï¼Œæ˜ç¡®æ˜¯5åˆ†é’Ÿç»´åº¦

---

## ä¿®å¤åçš„éªŒè¯

### æ–°çš„æ•°æ®æµ

```
[Binance API]
    â†“
[5åˆ†é’ŸKçº¿ x 300æ ¹]
    â†“
    â”œâ†’ currentPrice (5mæœ€æ–°æ”¶ç›˜)
    â”œâ†’ EMA20/50/200 (åŸºäº5mè®¡ç®—)
    â”œâ†’ RSI7/MACD (åŸºäº5mè®¡ç®—)
    â”œâ†’ 1hå˜åŒ– (5mç¬¬-12æ ¹ vs æœ€æ–°)
    â”œâ†’ 4hå˜åŒ– (5mç¬¬-48æ ¹ vs æœ€æ–°)
    â””â†’ ATR/Volume (åŸºäº5mè®¡ç®—)
    â†“
[ç»Ÿä¸€5åˆ†é’Ÿç»´åº¦çš„å®Œæ•´å¸‚åœºç”»åƒ]
    â†“
[AIåˆ†æ]
```

### é¢„æœŸæ•ˆæœ

**Beforeï¼ˆæ—¶é—´å‘¨æœŸæ··ä¹±ï¼‰**ï¼š
```
ä»·æ ¼(3m): 102300
EMA20(4h): 102000
â†’ Promptè¯´: "Strong uptrend"
â†’ AIå›°æƒ‘: é•¿æœŸçœ‹æ˜æ˜åœ¨è·Œï¼Œä¸ºä»€ä¹ˆè¯´Strong uptrendï¼Ÿ
â†’ AIè¾“å‡º: "ä¸‹è¡Œè¶‹åŠ¿" (ä¸promptå†²çª)
```

**Afterï¼ˆæ—¶é—´å‘¨æœŸç»Ÿä¸€ï¼‰**ï¼š
```
ä»·æ ¼(5m): 102300
EMA20(5m): 102400
EMA50(5m): 102500
EMA200(5m): 102600
â†’ Promptè¯´: "Price below all EMAs (bearish structure on 5m)"
â†’ AIç†è§£: 5åˆ†é’Ÿç»´åº¦çœ‹ç¡®å®åœ¨ä¸‹è·Œç»“æ„ä¸­
â†’ AIè¾“å‡º: "ä¸‹è¡Œè¶‹åŠ¿" (ä¸promptä¸€è‡´)
```

---

## æŠ€æœ¯ç»†èŠ‚

### EMAè®¡ç®—æ‰€éœ€Kçº¿æ•°é‡

| æŒ‡æ ‡ | æœ€å°‘éœ€è¦ | æ¨è | æˆ‘ä»¬ä½¿ç”¨ |
|------|---------|------|---------|
| EMA20 | 20æ ¹ | 40æ ¹ | 300æ ¹ âœ“ |
| EMA50 | 50æ ¹ | 100æ ¹ | 300æ ¹ âœ“ |
| EMA200 | 200æ ¹ | 400æ ¹ | 300æ ¹ âš ï¸ |

**300æ ¹5åˆ†é’ŸKçº¿**ï¼š
- æ—¶é—´è·¨åº¦ï¼š300 Ã— 5åˆ†é’Ÿ = 1500åˆ†é’Ÿ = **25å°æ—¶**
- è¶³å¤Ÿè®¡ç®—EMA20/50
- EMA200ç•¥æ˜¾ä¸è¶³ï¼Œä½†å¯æ¥å—ï¼ˆä¼šæœ‰slight warm-up effectï¼‰

**å¦‚æœéœ€è¦æ›´å‡†ç¡®çš„EMA200**ï¼š
```go
klines5m, err := getKlines(symbol, "5m", 500) // 500æ ¹ = 41.7å°æ—¶
```

### ä»·æ ¼å˜åŒ–è®¡ç®—

**æ—§æ–¹æ³•**ï¼ˆæ··åˆå‘¨æœŸï¼‰ï¼š
```go
// 1å°æ—¶å˜åŒ– = 20ä¸ª3åˆ†é’ŸKçº¿å‰
price1hAgo := klines3m[len(klines3m)-21].Close  // 3åˆ†é’Ÿæ•°æ®

// 4å°æ—¶å˜åŒ– = 1ä¸ª4å°æ—¶Kçº¿å‰
price4hAgo := klines4h[len(klines4h)-2].Close  // 4å°æ—¶æ•°æ®
```

**æ–°æ–¹æ³•**ï¼ˆç»Ÿä¸€5åˆ†é’Ÿï¼‰ï¼š
```go
// 1å°æ—¶å˜åŒ– = 12ä¸ª5åˆ†é’ŸKçº¿å‰ (12 Ã— 5 = 60åˆ†é’Ÿ)
price1hAgo := klines5m[len(klines5m)-13].Close

// 4å°æ—¶å˜åŒ– = 48ä¸ª5åˆ†é’ŸKçº¿å‰ (48 Ã— 5 = 240åˆ†é’Ÿ)
price4hAgo := klines5m[len(klines5m)-49].Close
```

---

## å½±å“åˆ†æ

### âœ… æ­£é¢å½±å“

1. **AIåˆ†æå‡†ç¡®æ€§æå‡**
   - æ‰€æœ‰æ•°æ®æ¥è‡ªåŒä¸€æ—¶é—´ç»´åº¦
   - ä¸å†æœ‰"3åˆ†é’Ÿä»·æ ¼ vs 4å°æ—¶EMA"çš„çŸ›ç›¾
   - AIçš„æ¨ç†æ›´ä¸€è‡´

2. **Promptæ›´æ¸…æ™°**
   - æ˜ç¡®æ ‡æ³¨"(5m)"
   - ä¸ç”¨è¯¯å¯¼æ€§çš„"Strong uptrend"
   - AIç†è§£æ›´å‡†ç¡®

3. **ä»£ç æ›´ç®€æ´**
   - åªéœ€è·å–ä¸€ç»„Kçº¿æ•°æ®
   - å‡å°‘äº†klines3må’Œklines4hçš„æ··æ·†
   - ç»´æŠ¤æ›´å®¹æ˜“

### âš ï¸ æ½œåœ¨å½±å“

1. **EMA200ç²¾åº¦ç•¥é™**
   - æ—§ï¼š220æ ¹4å°æ—¶Kçº¿ = 880å°æ—¶ = 36.7å¤©
   - æ–°ï¼š300æ ¹5åˆ†é’ŸKçº¿ = 25å°æ—¶
   - **å½±å“**ï¼šEMA200ä¼šæœ‰warm-up effectï¼ŒåˆæœŸä¸å¤Ÿå‡†ç¡®
   - **ç¼“è§£**ï¼šå¯å¢åŠ åˆ°500æ ¹ï¼ˆ41.7å°æ—¶ï¼‰æˆ–1000æ ¹ï¼ˆ83.3å°æ—¶â‰ˆ3.5å¤©ï¼‰

2. **ä¿¡å·çµæ•åº¦å˜åŒ–**
   - æ—§ï¼š4å°æ—¶EMAååº”æ…¢ï¼Œæ›´ç¨³å®š
   - æ–°ï¼š5åˆ†é’ŸEMAååº”å¿«ï¼Œæ›´çµæ•
   - **å½±å“**ï¼šå¯èƒ½å¢åŠ äº¤æ˜“é¢‘ç‡
   - **ç¼“è§£**ï¼šæŒä»“ä¿æŠ¤æœºåˆ¶ï¼ˆ15åˆ†é’Ÿ+80%é˜ˆå€¼ï¼‰å·²ç»åœ¨æ§åˆ¶é¢‘ç‡

3. **APIè¯·æ±‚å˜åŒ–**
   - æ—§ï¼š2æ¬¡è¯·æ±‚ï¼ˆ3åˆ†é’Ÿ40æ ¹ + 4å°æ—¶220æ ¹ï¼‰
   - æ–°ï¼š1æ¬¡è¯·æ±‚ï¼ˆ5åˆ†é’Ÿ300æ ¹ï¼‰
   - **å½±å“**ï¼šè¯·æ±‚æ•°å‡å°‘ï¼Œä½†å•æ¬¡æ•°æ®é‡å¢åŠ 
   - **è¯„ä¼°**ï¼šæ€»ä½“ç½‘ç»œè´Ÿè½½ç›¸å½“

---

## ç›‘æ§è®¡åˆ’

### ç«‹å³éªŒè¯ï¼ˆé‡å¯åç¬¬ä¸€ä¸ªå‘¨æœŸï¼‰

```bash
# 1. æ£€æŸ¥æ—¥å¿—ä¸­çš„EMAæ ‡æ³¨
tail -500 nofx.log | grep "Position vs EMAs"
# åº”è¯¥çœ‹åˆ°: "Position vs EMAs (5m): ..."

# 2. æ£€æŸ¥è¶‹åŠ¿è§£è¯»
tail -500 nofx.log | grep "Trend (5m):"
# åº”è¯¥çœ‹åˆ°: "â†’ Trend (5m): Price above all EMAs (bullish structure on 5m)"
# æˆ–: "â†’ Trend (5m): Price below all EMAs (bearish structure on 5m)"

# 3. éªŒè¯AIçš„æ¨ç†ä¸promptä¸€è‡´æ€§
tail -500 nofx.log | grep -A 50 "Position vs EMAs" | grep "AIåŸå§‹é¢„æµ‹JSON"
# å¯¹æ¯”promptè¯´çš„è¶‹åŠ¿å’ŒAIçš„reasoningæ˜¯å¦ä¸€è‡´
```

### æŒç»­ç›‘æ§ï¼ˆæ¯å¤©ï¼‰

```bash
# 1. ç»Ÿè®¡AIè¯´"ä¸‹è¡Œ"ä½†promptæ˜¾ç¤º"above EMAs"çš„æ¬¡æ•°ï¼ˆåº”è¯¥å¤§å¹…å‡å°‘ï¼‰
grep "bearish structure on 5m" nofx.log | wc -l
grep "Price below all EMAs" nofx.log | wc -l

# 2. ç»Ÿè®¡AIæ¨ç†ä¸promptçš„ä¸€è‡´æ€§
# å¦‚æœpromptè¯´"above EMAs"ï¼ŒAIåº”è¯¥å€¾å‘é¢„æµ‹up
# å¦‚æœpromptè¯´"below EMAs"ï¼ŒAIåº”è¯¥å€¾å‘é¢„æµ‹down
```

**å¥åº·æ ‡å‡†**ï¼š
- âœ… Promptè¯´"above EMAs" â†’ AIé¢„æµ‹upçš„æ¯”ä¾‹ >70%
- âœ… Promptè¯´"below EMAs" â†’ AIé¢„æµ‹downçš„æ¯”ä¾‹ >70%
- âœ… ä¸å†å‡ºç°"promptè¯´ä¸Šè¡Œä½†AIè¯´ä¸‹è¡Œ"çš„çŸ›ç›¾

---

## å¯é€‰ä¼˜åŒ–

### å¦‚æœéœ€è¦æ›´å‡†ç¡®çš„EMA200

```go
// å¢åŠ åˆ°500æ ¹æˆ–1000æ ¹
klines5m, err := getKlines(symbol, "5m", 500)  // 41.7å°æ—¶
// æˆ–
klines5m, err := getKlines(symbol, "5m", 1000) // 83.3å°æ—¶ â‰ˆ 3.5å¤©
```

### å¦‚æœéœ€è¦å¤šæ—¶é—´æ¡†æ¶åˆ†æ

```go
// ä¿ç•™5åˆ†é’Ÿä½œä¸ºä¸»è¦åˆ†æ
klines5m, err := getKlines(symbol, "5m", 300)

// æ·»åŠ 1å°æ—¶ä½œä¸ºè¾…åŠ©ï¼ˆé•¿æœŸè¶‹åŠ¿å‚è€ƒï¼‰
klines1h, err := getKlines(symbol, "1h", 200)  // 200å°æ—¶ â‰ˆ 8å¤©
ema200_1h := calculateEMA(klines1h, 200)

// Promptä¸­æ˜ç¡®åŒºåˆ†
userPrompt += fmt.Sprintf("Position vs EMAs (5m): %s EMA20(%.2f) ...\n", ...)
userPrompt += fmt.Sprintf("Long-term EMA200 (1h): %.2f (reference only)\n", ema200_1h)
```

---

## æ€»ç»“

### é—®é¢˜
- æ··ç”¨3åˆ†é’Ÿä»·æ ¼å’Œ4å°æ—¶EMA
- Promptè¯´"Strong uptrend"ä½†AIåˆ†æè¯´"ä¸‹è¡Œ"
- æ—¶é—´ç»´åº¦ä¸ç»Ÿä¸€å¯¼è‡´æ•°æ®çŸ›ç›¾

### ä¿®å¤
- âœ… ç»Ÿä¸€ä½¿ç”¨5åˆ†é’ŸKçº¿è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
- âœ… Promptæ˜ç¡®æ ‡æ³¨"(5m)"
- âœ… è¶‹åŠ¿æè¿°æ›´å‡†ç¡®ï¼ˆ"Price above EMAs"è€Œé"Strong uptrend"ï¼‰

### é¢„æœŸæ•ˆæœ
- AIåˆ†æä¸è¾“å…¥æ•°æ®ä¸€è‡´æ€§æå‡
- ä¸å†å‡ºç°"promptè¯´ä¸Šè¡Œä½†AIè¯´ä¸‹è¡Œ"çš„çŸ›ç›¾
- äº¤æ˜“å†³ç­–æ›´å‡†ç¡®

---

**ä¿®å¤æ—¶é—´**ï¼š2025-01-07 14:30
**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `market/data.go` (æ—¶é—´å‘¨æœŸç»Ÿä¸€)
- `decision/agents/prediction_agent.go` (promptæ ‡æ³¨ä¼˜åŒ–)

**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤ï¼Œç­‰å¾…é‡å¯éªŒè¯
